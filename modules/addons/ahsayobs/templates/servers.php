<?php
$statusGreen = 'iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAVNJREFUeNrUk09OwkAUh9+gUKpAFIuIfxJilLIlMd6gaw+Ax/AY7r2AnMFFb2DcC5gYYlBotYKttEwp83zjQtFIN6x8yZfJ9PfypZM3wxARFqkELFgLC5ZnN+yyQF9YjrR12hpEiegRJghoQIQunj7PF1DlQOB5dadi6Nt6cSWlKiPu8+ZTq9bu3tUoPyPc+UcQWK9sHRh6oVIOXF91XpzE2AtUXTss72tlQ+axR4AQjb313aJlWSCEAM75J3JS2dVMUebUdREjECWcojLwBiCZRJOvKB2mFZnH/wEXvb7b5zbaKmR+No6jMZd5/Bg5mt3HByupJQE24Js8gD/0LJnHC0zecNuO6d06HcGmAWRBTCEK/NZbh9+PTJn/FrDZq8wYS0GeVeE4cQIldkT6TZq/DT28gWtxBa/YpP73OMESLWuE8seli4gh9YdzBf/zMX0IMACs96WetcYlTQAAAABJRU5ErkJggg==';
$statusRed = 'iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAVlJREFUeNrUU0FOg0AU/VMbCA1tjI0iLmx1U9OQNk2MN2DtAeoxPIZ7L2DP4IIbGDdNF9oNITXBlISWgi0OhcGPRNMQYcPKSV7I5z0e//2ZIXEcQ5lVgZKrtEF1t3ggJHnRQNchlipCRrwjNAYwCgHcm0zkasawgcK7s15PPe/3JV4U+U/Po/p4PNAnkwHytwg3NwJ+PDxVFPVEUdq26wqmaVYWniccd7ttudNRWdpZfgcBtt1stSTDMIAxBpTSbyQ7VRdFKUhj3RcZyEEU8SvbBm+5hHC7/eVorcYH6UzyO6A4MMc0aWxZgpgRhr5PaTrQ/G1EgfY2m80POQ6aWP/gAOGs1/OELzRAdjR1HO3FdQ3CmF9P5hpF/nSzMXRKtYTPGpDdo0wI4fBvF1cA1xj2Et2PcPIW9v38BPC4AHhF/UeRwR4+9hH8H4cuTJKgPsg1+J+X6UuAAQAG85S2YfuhcwAAAABJRU5ErkJggg==';
$iconMagnify = 'iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAl5JREFUeNqMk01oE1EQx99+mmSTbLayWqtN+hWxIW21VeOhpDEVBIupFBQRAgUL6rWth57tVSgIvWnBiyj1EBDpQdCDH4RCIVAbTSm9pBGDJqkxyW42u+u8kGKzbsGBH++D/8ybmfceEYlEkJlRFIURCIIYgGUbwAElIKPrekJV1TyAaHSwddrs/MXzo5HeM4PnetpEZ2tVlnPxePzrm1cvu4q7ubeg2aa8Xi+CiE2ACZzTNTZxezbYffKU333EKdIkQbMM4/B0dHhau/ocycQqKUvlbRKnYaRWqw0GwhGfQzjsETiWJQlE7KWF5+4Tx3qGL1/rwzq6Wq2apd/u9Q+58SSTr0gYo8A3cLZzeelRO60oilkA3mK1tqhavRzUe9zpNArSuQoDvvxBGZQ1RSoi6hBv5lwvRa0WwbdMyrKMTEgn1z5laIqklJquGp1xYutrH3ewjhQEAfE8jxwOB7Lb7YjjOMSy7Gbs+VKaqf1WqqrWfDJJULs/v2cfLy4kS6XSKmmMDtfoYRhm/N6du/NTN6/GV2IvUroila0sZSFUubISW/5yffzKh43P668lSfpBhMNhpGnaHj6bjZuYnr7/IBq9NZ/P555BTD/QDeBe/AK2gHc2my3rcrn+vkQ4+YIoHo3MzMzNRaM3HoLzU9jeBDbMmghvAGWzWYRCoRAKBoNjk5NTC4nElt7ff3qRpukh/BfgH0DN5D80mdvtRoFAYDaVyuojI6NPwPkSdvxfw0qLKIrDUEKoUCh8g9Tewx6+uloDZd+o7FtjjYoD4D60NEa9gWaCahjruj8CDADbZyPFMNpHlwAAAABJRU5ErkJggg==';
$iconNetwork = 'iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAstJREFUeNpsU0tME1EUPTPTaafttIi0U6klRdpACFELBhQiGk0IJK5cGY1hYWJcyNKlS1cm7nThxpVBWbHAREj8BUwQi/ET+VR+JZK2Q/906GdaOr4ZWwrGl5zMzX33nHvezR2KHnmD/cMfAWVp4KFjh0BRl0nGXbnZhKK8Q6k4qWTiEqTUPkWHw8cBOfegS0DvQCvv8goc33hUj2hOkV76kxemfu4Mkpr7BGKVwFA9w/v9KaX8aPhsw2CPwHgvnbJxgeAOXZZL9MlmC3exlRd4piTMLYonUN57S+pllUQrSREqkI5d6RToPjvHuKx1Zmwni5B283C7GvD5u4jIDtDtsbs8XKFPra3ydMimtfYKMHTM2ub0rydQH8sSa4BBR+H13G8EN0WcMzmwvBqB3co5V6TEEKGMaTNQagNpofS8qVQEgvEMDAYWxCoSOT2c3i5MTgcgpuJgUTYRTkttiEW5GtOhSJwq6I3YQxnFcgnEBNLJMGLRXSgUjXq7B3IqQhEOXROgmWq8XizkfbTRyBuJCEveQBMFhWVhYE0oZDIQjjsgsaUs4azXBFjub0TRU2IofP60u5nX0TQhUdCpCuq48zKcbjsaHcDE9I9t6E1TUMoVAaO1KjYhprNXEpGo2dfucahktmJONnAQbDQCy0tiYC38CRw/oeZvD3SBwfIrVCCTDZwN6Ztas3nZ7Ky3sDbeqDMwjJKSsrsfvq5svZ/f+KgsjN/D9MO4xon9AnVgC3XaJta5muC71gdPfzeCs17tprl3FWszfnwbm0V6K0Qy4eoiHRRQJ8sTmLV8hx5YkEe0mw79YxJX1gU5Aomg9K/A4TNqf4ql4hktbme/4Eb0zv/KVNs2Ag+Bj6CToI3AglEJV59d1wTGb71QP/MEewQbldhPsKg6IF7BVeyrMKk/Ge6absJO9WttosoMnmSfV5pWn0D+DmT/CDAAu3QImARY0gcAAAAASUVORK5CYII=';
?>
<h2 class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top mod-hdr">Ahsay OBS Servers</h2>

<table class="form" width="100%" border="0" cellspacing="2" cellpadding="3">
	<tbody>
		<tr>
			<td class="fieldarea" colspan="2" style="text-align:center;">
				<table style="width:100%" class="ui-widget ui-widget-content" cellspacing="1" cellpadding="0">
					<thead>
						<tr class="ui-widget-header">
							<th class="ui-state-default">&nbsp;</th>
							<th class="ui-state-default">Name (hostname)</th>
							<th class="ui-state-default">IP</th>
							<th class="ui-state-default">Users</th>
							<th class="ui-state-default">License Name</th>
							<th class="ui-state-default">Version</th>
							<th class="ui-state-default">Active</th>
						</tr>
					</thead>
				
					<?php $scount = 0; ?>
					<?php if (is_array($servers)): ?>
					<?php $totals = array(); ?>
					<?php foreach($servers as $num => $server): ?>
					<?php //var_dump($server); ?>
					<tbody class="server" serverid="<?php echo $server['id']; ?>">
						<tr serverid="<?php echo $server['id']; ?>" class="server">
							<td colspan="7" style="background-color:#ccc;height:2px;width:100%;" class="ui-corner-top ui-state-active">
								<div style="height:10px;width:100%;"></div>
							</td>
						</tr>
						<tr class="server <?php if ($scount % 2 != 0): ?>odd<?php else: ?>even<?php endif; ?>" serverid="<?php echo $server['id']; ?>">
							<td>
								<a href="configservers.php?action=manage&id=<?php echo $server['id']; ?>" title="Edit WHMCS Server Settings" class="edit small-icon"></a>
							</td>
							<td>
								<div style="width:90%;margin: 0 auto;">
									<div style="float:left;">
										<div class="module-icon obs" style=""></div>
									</div>
									<?php echo $server['name']; ?> (<?php echo $server['hostname']; ?>)
								</div>
							</td>
							<td>
								<?php echo $server['ipaddress']; ?>
							</td>
							<td>
								<?php echo $server['licenses']['licensing']['OBM']['Used'] + $server['licenses']['licensing']['ACB']['Used']; ?>
							</td>
							<td class="usage">
								<?php echo $server['licenses']['LicenseeName']; ?>
							</td>
							<td class="usage">
								<?php echo $server['licenses']['ObsVersion']; ?>
							</td>
							<td class="usage">
								<?php if ($server['disabled'] == 0): ?>
								<img src="data:image/png;base64,<?php echo $statusGreen; ?>">
								<?php else: ?>
								<img src="data:image/png;base64,<?php echo $statusRed; ?>">
								<?php endif; ?>
							</td>
						</tr>
						<tr class="server altrow <?php if ($scount % 2 != 0): ?>odd<?php else: ?>even<?php endif; ?>" serverid="<?php echo $server['id']; ?>">
							<td colspan="1" width="16">
								&nbsp;
							</td>
							<td colspan="6" class="licenserow bottom">
								<div style="width:100%;margin: 0 auto;">
									
									<?php foreach($server['licenses']['licensing'] as $license => $info): ?>
										<?php $class = (is_numeric($info['Available']) && $info['Available'] > 5) ? 'ui-state-default' : 'ui-state-error'; ?>
										<?php if ($info['Available'] == 'Unlimited'): ?>
										<?php $class = 'ui-state-default'; ?>
										<?php $totals['MySQL']['Quota'] = 'Unlimited'; ?>
										<?php $totals['MySQL']['Available'] = 'Unlimited'; ?>
										<?php else: ?>
										<?php $totals[$license]['Used'] = $info['Used'] + $totals[$license]['Used']; ?>
										<?php $totals[$license]['Quota'] = $info['Quota'] + $totals[$license]['Quota']; ?>
										<?php $totals[$license]['Available'] = $info['Available'] + $totals[$license]['Available']; ?>
										<?php endif; ?>
										<?php if (strpos($license, 'JVM') !== false) continue; ?>
										<?php if (!array_key_exists('Used', $info)) $info['Used'] = '&#8734;'; ?>
										<button id="<?php echo $license; ?>" class="<?php echo $class; ?> module">
											<div class="module-icon <?php echo ahsayobs_cssClassForModuleIcon($license); ?>">

											</div>
											<?php /* <?php echo $license; ?> <br/>*/ ?><?php echo $info['Used']; ?> / <?php echo $info['Quota'] == 'Unlimited' ? '&#8734;' : $info['Quota']; ?>
										</button>
									<?php endforeach; ?>
								</div>
							</td>
						</tr>
						<tr serverid="<?php echo $server['id']; ?>" class="server">
							<td colspan="7" style="background-color:#999;height:5px;padding:0;" class="ui-corner-bottom ui-state-default">
								<div class="scollapsor">
									<div class="ui-icon ui-icon-triangle-1-s"></div>
								</div>
							</td>
						</tr>
					</tbody>
					<?php $scount++; ?>
					<?php endforeach; ?>
					<?php endif; ?>
					<tfoot>
						<tr>
							<td style="border-top:1px solid #ececec;text-align:center;" colspan="7">
								Total License Distribution
							</td>
						</tr>
						<tr>
							<td style="border-top:1px solid #ececec;text-align:center;" colspan="7" class="licenserow">
								<div style="width:100%;margin: 0 auto;">
									
									<?php foreach($totals as $license => $info): ?>
										<?php $class = (is_numeric($info['Available']) && $info['Available'] >= 5) ? 'ui-state-default' : 'ui-state-error'; ?>
										<?php if ($info['Available'] == 'Unlimited'): ?>
										<?php $class = 'ui-state-default'; ?>
										<?php endif; ?>
										<?php if (strpos($license, 'JVM') !== false) continue; ?>
										<?php if (!array_key_exists('Used', $info)) $info['Used'] = '&#8734;'; ?>
										
										<?php if ($info['Quota'] === 'Unlimited') $info['Quota'] = '&#8734;'; ?>
										<button id="<?php echo $license; ?>" class="<?php echo $class; ?> module">
											<div class="module-icon <?php echo ahsayobs_cssClassForModuleIcon($license); ?>">
											</div>
											<?php /*<?php echo $license; ?> <br/>*/ ?><?php echo $info['Used']; ?> / <?php echo $info['Quota']; ?>
										</button>
									<?php endforeach; ?>
								</div>
							</td>
						</tr>
					</tfoot>
				</table>
			</td>
		</tr>
	</tbody>
</table>
<script type="text/javascript">
function collapseServers(sid){
	if (!$(this).find('.ui-icon').is('.ui-icon-triangle-1-s')) {
		$(this).find('.ui-icon').removeClass('ui-icon-triangle-1-n').addClass('ui-icon-triangle-1-s');
	} else {
		$(this).find('.ui-icon').removeClass('ui-icon-triangle-1-s').addClass('ui-icon-triangle-1-n');
	}

	$rows = $('tr[serverid='+sid+']');
	$rows.each(function(){
		if ($(this).is('tr.altrow')){
			$(this).toggle('fast');
		}
	});
};

function collapseAllServers(but){
	$('tr[serverid]').each(function(){
		if ($(this).is('tr.altrow')){
			if (but !== undefined && $(this).is('tr[serverid='+but+']')){
				$(this).show('fast');
			} else {
				$(this).hide('fast');
			}
		}
	});
	$('.scollapsor .ui-icon').each(function(){
		$(this).removeClass('ui-icon-triangle-1-n').addClass('ui-icon-triangle-1-s');
	});
};
function expandAllServers(){
	$('tr[serverid]').each(function(){
		if (!$(this).is('tr.server')){
			$(this).show('fast');
		}
	});
	$('.scollapsor .ui-icon').each(function(){
		$(this).removeClass('ui-icon-triangle-1-s').addClass('ui-icon-triangle-1-n');
		
	});
};
$(document).ready(function(){
	$( ".scollapsor" ).live('click', function(){
		sid = $(this).parents('tr').first().prevAll('[serverid]').first().attr('serverid');
		collapseServers.apply(this, [sid]);
	});
	$( ".lcollapsor" ).live('click', function(){
		$('tr.legend').toggle();
		if (!$(this).find('.ui-icon').is('.ui-icon-triangle-1-s')) {
			$(this).find('.ui-icon').removeClass('ui-icon-triangle-1-n').addClass('ui-icon-triangle-1-s');
		} else {
			$(this).find('.ui-icon').removeClass('ui-icon-triangle-1-s').addClass('ui-icon-triangle-1-n');
		}
	});
	collapseAllServers();
});
</script>